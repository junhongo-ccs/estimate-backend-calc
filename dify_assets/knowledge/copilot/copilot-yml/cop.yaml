kind: app
version: 0.5.0
app:
  name: 'é–‹ç™ºè¦‹ç©ã‚‚ã‚Šã‚µãƒãƒ¼ã‚¿ãƒ¼PoCï¼ˆBSæº–æ‹ ãƒ»å¿œæ´PJå¯¾å¿œï¼‰'
  description: >
    BSäº‹æ¥­éƒ¨å‘ã‘ï¼šFY2026åˆ©ç›Šç®¡ç†è¡¨ã®ä¿‚æ•°ã«æº–æ‹ ã—ãŸAIè¦‹ç©ã‚‚ã‚ŠPoCã€‚
    - 1äººæœˆ=160hã€éƒ¨é–€åˆ¥ã€Œé–“æ¥è²»å˜é‡‘ï¼ˆå††/hï¼‰ã€ã‚’ç”¨ã„ãŸå®Ÿæ…‹è¨ˆç®—
    - è²©ç®¡è²»ï¼ˆSG&Aï¼‰ã¯ç²—åˆ©ãƒ™ãƒ¼ã‚¹ã§ã€Œæœ¬éƒ¨ï¼‹å…¨ç¤¾ï¼ˆBS=47.8%ï¼‰ã€ã‚’æ§é™¤
    - å¿œæ´PJï¼ˆéƒ¨é–€é…åˆ†ï¼‰ã‚’åŠ é‡å¹³å‡ã§åæ˜ 
  mode: advanced-chat
  icon: "ğŸ¤–"
  icon_background: "#FFEAD5"
  use_icon_as_answer_icon: false

workflow:
  features:
    file_upload:
      enabled: false
  opening_statement: >
    å…¥åŠ›ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã§è¦‹ç©ã‚‚ã‚Šã‚’é–‹å§‹ã—ã¾ã™ã€‚
    â€»ä¿®æ­£ã¯ä¸Šéƒ¨UIã€Œç·¨é›†ã€ã‹ã‚‰å¯èƒ½ã§ã™ã€‚
  language: ""

  graph:
    nodes:
      # ---- Start: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ› ----
      - id: start
        type: start
        position: { x: 80, y: 280 }
        data:
          title: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
          selected: true
          variables:
            # --- BSæ‰€å±éƒ¨é–€ ---
            - variable: department
              label: "ã€BSã€‘æ‰€å±éƒ¨é–€ï¼ˆæœ¬éƒ¨ï¼‰"
              type: select
              required: true
              default: ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³äº‹æ¥­éƒ¨å…±é€š
              options:
                - ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³äº‹æ¥­éƒ¨å…±é€š
                - ãƒ“ã‚¸ãƒ»ä¼ç”»å–¶æ¥­éƒ¨
                - ãƒ“ã‚¸ãƒ»ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºéƒ¨
                - ï¼³ï¼¦ï¼†ï¼­å–¶æ¥­éƒ¨
                - ï¼³ï¼¦ï¼†ï¼­ç¬¬ï¼‘ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºéƒ¨
                - ï¼³ï¼¦ï¼†ï¼­ç¬¬ï¼’ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºéƒ¨
                - ï¼³ï¼¦ï¼†ï¼­äº‹æ¥­éƒ¨ï¼ˆå…±é€šï¼‰
                - ï¼£ï¼³å–¶æ¥­éƒ¨
                - ï¼£ï¼³ç¬¬ï¼‘ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºéƒ¨
                - ï¼£ï¼³ç¬¬ï¼’ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºéƒ¨
                - ï¼£ï¼³ã‚·ã‚¹ãƒ†ãƒ äº‹æ¥­éƒ¨ï¼ˆå…±é€šï¼‰
                - ï¼¤ï¼´å–¶æ¥­éƒ¨
                - ï¼¤ï¼´ç¬¬ï¼‘é–‹ç™ºéƒ¨
                - ï¼¤ï¼´ç¬¬ï¼’é–‹ç™ºéƒ¨
                - ï¼¤ï¼´äº‹æ¥­éƒ¨ï¼ˆå…±é€šï¼‰
                - ç¤¾ä¼šãƒ»ç§‘å­¦ã‚·ã‚¹ãƒ†ãƒ å–¶æ¥­éƒ¨
                - ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹ã‚·ã‚¹ãƒ†ãƒ éƒ¨
                - ç¤¾ä¼šãƒ»ç§‘å­¦ã‚·ã‚¹ãƒ†ãƒ äº‹æ¥­éƒ¨ï¼ˆå…±é€šï¼‰
                - ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ã‚¸ãƒã‚¹æ¨é€²å®¤

            # --- å¿œæ´PJï¼ˆè‡ªç”±è¨˜è¿°ï¼šéƒ¨é–€:å‰²åˆï¼‰ ---
            - variable: dept_allocation
              label: "ã€ä»»æ„ã€‘å¿œæ´PJé…åˆ†ï¼ˆéƒ¨é–€: å‰²åˆï¼‰â€»åˆè¨ˆ1.0å‰å¾Œã§OKï¼ˆè‡ªå‹•æ­£è¦åŒ–ï¼‰"
              type: paragraph
              required: false
              default: |
                ä¾‹)
                ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³äº‹æ¥­éƒ¨å…±é€š: 0.6
                ï¼£ï¼³ç¬¬ï¼‘ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºéƒ¨: 0.4

            # --- ãƒ©ãƒ³ã‚¯ãƒŸãƒƒã‚¯ã‚¹ ---
            - variable: team_ratio
              label: "ã€ä»»æ„ã€‘ãƒ©ãƒ³ã‚¯ãƒŸãƒƒã‚¯ã‚¹ï¼ˆRank:æ¯”ç‡ï¼‰"
              type: text-input
              required: false
              default: "Rank3:0.8, Rank2:0.2"

            # --- ç®—å‡ºãƒãƒªã‚·ãƒ¼/ç”Ÿç”£æ€§ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ« ---
            - variable: estimation_profile
              label: "ã€ç®—å‡ºãƒãƒªã‚·ãƒ¼ã€‘å“è³ªãƒ»æœŸé–“ã®æ±ºå®š"
              type: select
              required: false
              default: enterprise
              options:
                - poc
                - enterprise
                - mission_critical

            # --- ç›®æ¨™å–¶æ¥­åˆ©ç›Šç‡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ10%ï¼‰ ---
            - variable: target_margin
              label: "ã€å–¶æ¥­æˆ¦ç•¥ã€‘ç›®æ¨™å–¶æ¥­åˆ©ç›Šç‡"
              type: text-input
              required: false
              default: "10%"

            # --- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  ---
            - variable: target_platform
              label: "ã€æ¦‚è¦ã€‘ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆWeb/Mobileï¼‰"
              type: select
              required: true
              default: web_b2e
              options: [web_b2e, web_b2c, mobile, all]

            # --- é–‹ç™ºã‚¿ã‚¤ãƒ— ---
            - variable: dev_type
              label: " é–‹ç™ºã‚¿ã‚¤ãƒ—ï¼ˆæ–°è¦/ç§»æ¤ï¼‰"
              type: select
              required: true
              default: new
              options: [new, porting]

            # --- è¦æ¨¡ï¼ˆç”»é¢æ•°ï¼‰ ---
            - variable: screen_count
              label: "ã€è¦æ¨¡æ„Ÿã€‘ç”»é¢æ•°"
              type: number
              required: true
              default: 10

            # --- ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ« ---
            - variable: tables
              label: "ã€ãƒ‡ãƒ¼ã‚¿ã€‘ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£åï¼ˆæ”¹è¡Œ/ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰"
              type: paragraph
              required: false
              default: "ä¾‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼, å•†å“, æ³¨æ–‡å±¥æ­´"

            # --- ãƒ†ãƒ¼ãƒ–ãƒ«æ•°ï¼ˆç„¡å…¥åŠ›ãªã‚‰è‡ªå‹•è¨ˆæ•°ï¼‰ ---
            - variable: table_count
              label: " ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰åˆè¨ˆæ•°"
              type: number
              required: false
              default: ""

            # --- æ©Ÿèƒ½ä¸€è¦§ ---
            - variable: features
              label: "ã€æ©Ÿèƒ½ã€‘å®Ÿè£…æ©Ÿèƒ½ãƒªã‚¹ãƒˆï¼ˆ, ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰"
              type: paragraph
              required: true
              default: ""

            # --- é›£æ˜“åº¦ ---
            - variable: complexity
              label: " é–‹ç™ºé›£æ˜“åº¦"
              type: select
              required: true
              default: medium
              options: [low, medium, high]

            # --- ç´æœŸ ---
            - variable: duration
              label: "ã€æ¡ä»¶ã€‘é–‹ç™ºæœŸé–“ã®ä½™è£•"
              type: select
              required: true
              default: normal
              options: [long, normal, short]

            # --- è¦‹ç©ç¢ºåº¦ ---
            - variable: confidence
              label: " è¦‹ç©ã‚‚ã‚Šã®ç¢ºåº¦ï¼ˆä¸ç¢ºå®Ÿæ€§ï¼‰"
              type: select
              required: true
              default: medium
              options: [low, medium, high]

            # --- Phase2/3ï¼ˆæ—¢å­˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ ---
            - variable: phase2_items
              label: "ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‘Phase 2: è¨­è¨ˆãƒ»æ§‹æˆæ¡ˆï¼ˆæ”¹è¡Œ/ã‚«ãƒ³ãƒï¼‰"
              type: paragraph
              required: false
              default: ""
            - variable: phase3_items
              label: " Phase 3: UIãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ”¹è¡Œ/ã‚«ãƒ³ãƒï¼‰"
              type: paragraph
              required: false
              default: ""

      # ---- Code: è¦‹ç©ã‚‚ã‚Šè¨ˆç®—ï¼ˆBSæº–æ‹ ãƒ­ã‚¸ãƒƒã‚¯å†…è”µï¼‰----
      - id: code
        type: code
        position: { x: 380, y: 280 }
        data:
          title: ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ
          code_language: python3
          code: |
            # -*- coding: utf-8 -*-
            """
            BSç‰ˆ è¦‹ç©ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆDify Code Nodeç”¨ï¼‰
            - FY2026 åˆ©ç›Šç®¡ç†è¡¨ã®ä¿‚æ•°ã«æº–æ‹ ï¼ˆ1äººæœˆ=160hã€éƒ¨é–€åˆ¥ é–“æ¥è²»å˜é‡‘ã€æœ¬éƒ¨/å…¨ç¤¾è²©ç®¡è²»ç‡=BSã¯47.8%ï¼‰
            - SG&Aã¯ç²—åˆ©ãƒ™ãƒ¼ã‚¹ã§æ§é™¤ï¼ˆ= æœ¬éƒ¨è²©ç®¡è²»ç‡ + å…¨ç¤¾è²©ç®¡è²»ç‡ï¼‰
            - ç›®æ¨™å–¶æ¥­åˆ©ç›Šç‡ã‹ã‚‰ã®é€†ç®—å£²ä¾¡å¼ã‚‚ç²—åˆ©ãƒ™ãƒ¼ã‚¹ã®å®šç¾©ã«åˆã‚ã›ã¦ä¿®æ­£

            å…¥å‡ºåŠ›ï¼š
              def main(**kwargs) -> dict:
                return {"result": json.dumps(data, ensure_ascii=False, indent=2)}
            """

            import json
            import math
            from typing import List, Dict, Any

            # =========================================================
            # CONFIGURATION & CONSTANTS
            # =========================================================
            CONFIG = {
                "config_version": "2026-02-BS",
                "daily_rates": {
                    "sier_internal": 100000,  # å‚è€ƒå€¤ï¼ˆç›´æ¥ã¯ä½¿ã‚ãšã€ãƒ©ãƒ³ã‚¯äººæœˆã§è¨ˆç®—ï¼‰
                    "outsource": 80000
                },
                # ç”Ÿç”£æ€§ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆMD/FPç›¸å½“ä¿‚æ•°ï¼‰
                "estimation_profiles": {
                    "poc": {
                        "label": "PoC/é–‹ç™ºé‡è¦–å‹",
                        "productivity_factor": 0.075,
                        "description": "ã‚¹ãƒ”ãƒ¼ãƒ‰é‡è¦–ï¼ˆç®¡ç†å·¥æ•°ã‚’æŠ‘åˆ¶ï¼‰"
                    },
                    "enterprise": {
                        "label": "ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºå‹",
                        "productivity_factor": 1.4,
                        "description": "è¦ä»¶å®šç¾©ã€œå“è³ªä¿è¨¼ã¾ã§ã®æ¨™æº–ãƒ—ãƒ­ã‚»ã‚¹ã‚’å«ã‚€"
                    },
                    "mission_critical": {
                        "label": "é«˜ä¿¡é ¼æ€§å‹",
                        "productivity_factor": 2.2,
                        "description": "é‡‘è/åŸºå¹¹ç­‰ã®æ¥µã‚ã¦é«˜ã„å“è³ªåŸºæº–"
                    }
                },
                # ç°¡æ˜“FPåŸºæº–
                "fp_simplified": {
                    "screen_weight": 20,  # FP/ç”»é¢
                    "table_weight": 15,   # FP/ãƒ†ãƒ¼ãƒ–ãƒ«
                    "default_productivity": 0.075
                },
                # é›£æ˜“åº¦ãƒ»ç´æœŸãƒ»é–‹ç™ºã‚¿ã‚¤ãƒ—ä¿‚æ•°ï¼ˆå·¥æ•°å´ï¼‰
                "difficulty_multipliers": {"low": 0.8, "medium": 1.0, "high": 1.5, "very_high": 2.0},
                "duration_multipliers": {"long": 0.9, "normal": 1.0, "short": 1.2},
                "dev_type_multipliers": {
                    "new": {"design": 1.0, "dev": 1.0},
                    "porting": {"design": 0.5, "dev": 0.8}
                },
                # ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®å£²ä¾¡ãƒ—ãƒ¬ãƒŸã‚¢ãƒ 
                "platform_multipliers": {"web_b2e": 1.0, "web_b2c": 1.2, "mobile": 1.5, "all": 1.8},
                "buffer_multiplier": 1.1,
                # æç›Šè¨ˆç®—ï¼ˆãƒ©ãƒ³ã‚¯äººæœˆã‚³ã‚¹ãƒˆ/æ¨™æº–ãƒãƒ¼ãƒ æ§‹æˆï¼‰
                "profit_config": {
                    # PDFã®ãƒ©ãƒ³ã‚¯åˆ¥ï¼ˆæ™‚çµ¦â†’äººæœˆ=160hï¼‰ã«åˆã‚ã›ã¦ä¸Šæ›¸ã
                    "rank_costs": {
                        "Rank4": 1098000,  # L4: 6,860Ã—160h
                        "Rank3":  944000,  # L3: 5,900Ã—160h
                        "Rank2":  758000,  # L2: 4,740Ã—160h
                        "Rank1":  541000,  # L1: 3,380Ã—160h
                    },
                    "standard_team_ratio": {"Rank3": 0.8, "Rank2": 0.2}
                }
            }

            # =========================================================
            # BSäº‹æ¥­éƒ¨ï¼šéƒ¨é–€â†’(é–“æ¥è²»å˜é‡‘[å††/h], æœ¬éƒ¨è²©ç®¡è²»ç‡, å…¨ç¤¾è²©ç®¡è²»ç‡)
            # =========================================================
            BS_ORG_CONFIG: Dict[str, Dict[str, float]] = {
                # --- ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ ---
                "ãƒ“ã‚¸ãƒ»ä¼ç”»å–¶æ¥­éƒ¨":              {"indirect_per_hour": 2340, "hq_sga": 0.273, "corp_sga": 0.478},
                "ãƒ“ã‚¸ãƒ»ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºéƒ¨":            {"indirect_per_hour": 2340, "hq_sga": 0.273, "corp_sga": 0.478},
                "ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³äº‹æ¥­éƒ¨å…±é€š": {"indirect_per_hour": 2340, "hq_sga": 0.273, "corp_sga": 0.478},
                # --- SF&M ---
                "ï¼³ï¼¦ï¼†ï¼­å–¶æ¥­éƒ¨":                {"indirect_per_hour": 2030, "hq_sga": 0.263, "corp_sga": 0.478},
                "ï¼³ï¼¦ï¼†ï¼­ç¬¬ï¼‘ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºéƒ¨":        {"indirect_per_hour": 2030, "hq_sga": 0.263, "corp_sga": 0.478},
                "ï¼³ï¼¦ï¼†ï¼­ç¬¬ï¼’ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºéƒ¨":        {"indirect_per_hour": 2030, "hq_sga": 0.263, "corp_sga": 0.478},
                "ï¼³ï¼¦ï¼†ï¼­äº‹æ¥­éƒ¨ï¼ˆå…±é€šï¼‰":           {"indirect_per_hour": 2030, "hq_sga": 0.263, "corp_sga": 0.478},
                # --- CS ---
                "ï¼£ï¼³å–¶æ¥­éƒ¨":                   {"indirect_per_hour": 1940, "hq_sga": 0.309, "corp_sga": 0.478},
                "ï¼£ï¼³ç¬¬ï¼‘ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºéƒ¨":           {"indirect_per_hour": 1940, "hq_sga": 0.309, "corp_sga": 0.478},
                "ï¼£ï¼³ç¬¬ï¼’ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºéƒ¨":           {"indirect_per_hour": 1940, "hq_sga": 0.309, "corp_sga": 0.478},
                "ï¼£ï¼³ã‚·ã‚¹ãƒ†ãƒ äº‹æ¥­éƒ¨ï¼ˆå…±é€šï¼‰":         {"indirect_per_hour": 1940, "hq_sga": 0.309, "corp_sga": 0.478},
                # --- DT ---
                "ï¼¤ï¼´å–¶æ¥­éƒ¨":                   {"indirect_per_hour": 2320, "hq_sga": 0.381, "corp_sga": 0.478},
                "ï¼¤ï¼´ç¬¬ï¼‘é–‹ç™ºéƒ¨":                 {"indirect_per_hour": 2320, "hq_sga": 0.381, "corp_sga": 0.478},
                "ï¼¤ï¼´ç¬¬ï¼’é–‹ç™ºéƒ¨":                 {"indirect_per_hour": 2320, "hq_sga": 0.381, "corp_sga": 0.478},
                "ï¼¤ï¼´äº‹æ¥­éƒ¨ï¼ˆå…±é€šï¼‰":              {"indirect_per_hour": 2320, "hq_sga": 0.381, "corp_sga": 0.478},
                # --- ç¤¾ä¼šãƒ»ç§‘å­¦ã‚·ã‚¹ãƒ†ãƒ  ---
                "ç¤¾ä¼šãƒ»ç§‘å­¦ã‚·ã‚¹ãƒ†ãƒ å–¶æ¥­éƒ¨":           {"indirect_per_hour": 2220, "hq_sga": 0.408, "corp_sga": 0.478},
                "ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹ã‚·ã‚¹ãƒ†ãƒ éƒ¨":         {"indirect_per_hour": 2220, "hq_sga": 0.408, "corp_sga": 0.478},
                "ç¤¾ä¼šãƒ»ç§‘å­¦ã‚·ã‚¹ãƒ†ãƒ äº‹æ¥­éƒ¨ï¼ˆå…±é€šï¼‰":     {"indirect_per_hour": 2220, "hq_sga": 0.408, "corp_sga": 0.478},
                # --- ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ã‚¸ãƒã‚¹æ¨é€²å®¤ ---
                "ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ã‚¸ãƒã‚¹æ¨é€²å®¤":         {"indirect_per_hour": 3570, "hq_sga": 0.937, "corp_sga": 0.478},
            }

            DEFAULT_BS_DEPT = "ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³äº‹æ¥­éƒ¨å…±é€š"

            # =========================================================
            # Feature & Phase Item Mapsï¼ˆå…ƒPoCã®æ§‹é€ ã‚’è¸è¥²ï¼‰
            # =========================================================
            FEATURE_MAN_DAYS = {
                "auth": 3.0,
                "payment": 5.0,
                "search_basic": 2.0,
                "search_advanced": 4.0,
                "push_notification": 2.0,
                "sns_integration": 3.0,
                "admin_dashboard": 5.0,
                "api_external": 4.0,
                "offline_mode": 6.0,
                "multi_language": 3.0,
            }

            FEATURE_LABEL_MAP = {
                "èªè¨¼ãƒ»èªå¯ (Auth/SSO)": "auth",
                "æ±ºæ¸ˆåŸºç›¤é€£æº (Payment)": "payment",
                "æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° (Basic)": "search_basic",
                "é«˜åº¦ãªæ¤œç´¢ (AI/ãƒ™ã‚¯ãƒˆãƒ«)": "search_advanced",
                "ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥": "push_notification",
                "SNSé€£æºãƒ»ã‚·ã‚§ã‚¢": "sns_integration",
                "ç®¡ç†ç”»é¢ (Admin)": "admin_dashboard",
                "å¤–éƒ¨APIé€£æº": "api_external",
                "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ": "offline_mode",
                "å¤šè¨€èªå¯¾å¿œ (i18n)": "multi_language",
            }

            PHASE2_ITEMS = {
                "basic_design": 1000000,
                "detail_design": 1500000,
                "infra_design": 800000,
                "security_review": 500000,
                "standardization": 1200000,
            }

            PHASE2_LABEL_MAP = {
                "åŸºæœ¬è¨­è¨ˆæ›¸ä½œæˆ": "basic_design",
                "è©³ç´°è¨­è¨ˆæ›¸ä½œæˆ": "detail_design",
                "ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»ã‚¯ãƒ©ã‚¦ãƒ‰è¨­è¨ˆ": "infra_design",
                "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯©æŸ»ãƒ»å¯¾ç­–æ¡ˆ": "security_review",
                "é–‹ç™ºæ¨™æº–åŒ–ãƒ»å…±é€šéƒ¨è¨­è¨ˆ": "standardization",
            }

            PHASE3_ITEMS = {
                "logo_creation": {"fixed": 650000, "range": [500000, 800000]},
                "brand_guideline": {"fixed": 1200000, "range": [1000000, 1500000]},
                "ui_prototype": {"fixed": 800000, "range": [600000, 1200000]},
                "marketing_asset": {"fixed": 450000, "range": [300000, 600000]},
            }

            PHASE3_LABEL_MAP = {
                "ä¼æ¥­/ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒ­ã‚´åˆ¶ä½œ": "logo_creation",
                "ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ç­–å®š": "brand_guideline",
                "é«˜ç²¾åº¦UIãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—": "ui_prototype",
                "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ç´ æ/LP": "marketing_asset",
            }

            # =========================================================
            # HELPERS
            # =========================================================

            def resolve_keys(input_list, label_map, item_dict):
                if not isinstance(input_list, list):
                    return []
                resolved = []
                for x in input_list:
                    if not x:
                        continue
                    if x in label_map:
                        resolved.append(label_map[x])
                    elif x in item_dict:
                        resolved.append(x)
                # é‡è¤‡æ’é™¤
                return list(dict.fromkeys(resolved))


            def parse_list_from_text(val):
                # æ”¹è¡Œ/ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š â†’ list
                items = []
                if isinstance(val, str):
                    for line in val.replace('\r', '').split('\n'):
                        items.extend([x.strip() for x in line.split(',') if x.strip()])
                elif isinstance(val, list):
                    items = val
                return [x for x in items if x not in ['ãªã—', 'æœªå®š', 'ä¸æ˜', 'N/A', '-']]


            def parse_int(val, default=None):
                if isinstance(val, (int, float)):
                    return int(val)
                if isinstance(val, str) and val.strip():
                    try:
                        return int(val)
                    except Exception:
                        return default
                return default


            def parse_target_margin(val):
                if isinstance(val, (int, float)):
                    return float(val)
                if isinstance(val, str) and val.strip():
                    try:
                        v = val.replace('%', '').strip()
                        num = float(v)
                        return num/100.0 if num > 1.0 else num
                    except Exception:
                        return None
                return None


            def parse_team_ratio(text):
                # ä¾‹: "Rank3:0.8, Rank2:0.2"
                default = {"Rank3": 0.8, "Rank2": 0.2}
                if not isinstance(text, str) or not text.strip():
                    return default
                res = {}
                for part in text.split(','):
                    if ':' in part:
                        k, v = part.split(':', 1)
                        k = k.strip()
                        try:
                            s = float(v.strip())
                            if s >= 0 and k in CONFIG["profit_config"]["rank_costs"]:
                                res[k] = s
                        except Exception:
                            pass
                s = sum(res.values())
                if s > 0:
                    for k in list(res.keys()):
                        res[k] = res[k] / s
                    return res
                return default


            def parse_dept_allocation(text):
                # æ®µè½: ã€Œéƒ¨é–€: 0.6\nï¼£ï¼³ç¬¬ï¼‘ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºéƒ¨: 0.4ã€â†’ æ­£è¦åŒ–list
                items = []
                if isinstance(text, str) and text.strip():
                    for line in text.splitlines():
                        if ':' in line:
                            k, v = line.split(':', 1)
                            k = k.strip()
                            try:
                                s = float(v.strip())
                                if k in BS_ORG_CONFIG and s > 0:
                                    items.append({"dept": k, "share": s})
                            except Exception:
                                pass
                total = sum(i['share'] for i in items)
                if total > 0:
                    for i in items:
                        i['share'] = i['share'] / total
                return items


            def resolve_bs_org_rates(primary_dept: str, allocations: List[Dict[str, Any]] | None):
                # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ=ä¸»æ‰€å±100%
                if not primary_dept or primary_dept not in BS_ORG_CONFIG:
                    primary_dept = DEFAULT_BS_DEPT
                if not allocations:
                    cfg = BS_ORG_CONFIG[primary_dept]
                    return (cfg["indirect_per_hour"], cfg["hq_sga"], cfg["corp_sga"])

                # åŠ é‡å¹³å‡
                total = sum(max(0.0, float(a.get("share", 0.0))) for a in allocations)
                if total <= 0:
                    cfg = BS_ORG_CONFIG[primary_dept]
                    return (cfg["indirect_per_hour"], cfg["hq_sga"], cfg["corp_sga"])

                ipt = 0.0
                hq = 0.0
                corp = 0.478  # BSå›ºå®š
                for a in allocations:
                    dept = a.get("dept")
                    share = max(0.0, float(a.get("share", 0.0))) / total
                    if dept in BS_ORG_CONFIG and share > 0:
                        cfg = BS_ORG_CONFIG[dept]
                        ipt += cfg["indirect_per_hour"] * share
                        hq  += cfg["hq_sga"] * share
                return (int(round(ipt)), hq, corp)


            def compute_direct_labor_cost(total_man_days: float, team_ratio: Dict[str, float], rank_costs: Dict[str, int]) -> int:
                # äººæœˆæ›ç®—ï¼š20æ—¥/æœˆï¼ˆ= 160h/8hï¼‰
                man_months = total_man_days / 20.0
                avg_monthly_cost = sum(rank_costs.get(r, 0) * w for r, w in team_ratio.items())
                return int(man_months * avg_monthly_cost)


            def compute_indirect_cost(total_man_days: float, indirect_yen_per_hour: float) -> int:
                hours = total_man_days * 8.0
                return int(hours * indirect_yen_per_hour)


            def calculate_profitability_bs(total_price: int, cogs: int, hq_rate: float, corp_rate: float, target_margin_input: float | None):
                gross_profit = total_price - cogs
                sga_total_rate = hq_rate + corp_rate   # ç²—åˆ©ã«å¯¾ã™ã‚‹ç‡
                total_sga = int(gross_profit * sga_total_rate)
                operating_profit = gross_profit - total_sga
                operating_margin = (operating_profit / total_price) if total_price > 0 else 0.0

                suggested_price = 0
                if target_margin_input is not None:
                    # å–¶æ¥­åˆ©ç›Šç‡ Ï„ ã‚’é”æˆã™ã‚‹å¿…è¦å£²ä¾¡ï¼š Sales = COGS / (1 - Ï„/(1-Î±))
                    denom_base = (1.0 - sga_total_rate)
                    if denom_base > 0:
                        denom = 1.0 - (target_margin_input / denom_base)
                        if denom > 0:
                            suggested_price = int(cogs / denom)

                return {
                    "sales": total_price,
                    "cogs": cogs,
                    "gross_profit": gross_profit,
                    "operating_profit": operating_profit,
                    "operating_margin": f"{operating_margin:.1%}",
                    "target_margin_specified": f"{target_margin_input:.1%}" if target_margin_input is not None else None,
                    "suggested_price_to_attain_target": suggested_price,
                    "breakdown": {
                        "total_sga_cost": total_sga,
                        "hq_sga_rate": f"{hq_rate:.1%}",
                        "corp_sga_rate": f"{corp_rate:.1%}",
                    }
                }

            # =========================================================
            # MAIN LOGIC
            # =========================================================

            def main_logic(req_body, tables=[]):
                config = CONFIG

                # å…¥åŠ›å–å¾—
                method = req_body.get('method', 'screen')
                complexity = req_body.get('complexity') or 'medium'
                duration = req_body.get('duration') or 'normal'
                dev_type = req_body.get('dev_type') or 'new'
                target_platform = req_body.get('target_platform') or 'web_b2e'
                profile_key = req_body.get('estimation_profile') or 'poc'
                target_margin = req_body.get('target_margin')  # Noneå¯ï¼ˆfloatï¼‰

                # è¦æ¨¡
                screen_count = req_body.get('screen_count'); screen_count = 10 if screen_count is None else screen_count
                table_count = req_body.get('table_count'); table_count = 0 if table_count is None else table_count

                # éƒ¨é–€ãƒ»å¿œæ´é…åˆ†ãƒ»ãƒ©ãƒ³ã‚¯ãƒŸãƒƒã‚¯ã‚¹
                primary_dept = req_body.get('department')
                dept_allocation = req_body.get('dept_allocation')  # list(dict)æƒ³å®š
                team_ratio = req_body.get('team_ratio')  # dictæƒ³å®š

                # é¸æŠé …ç›®ã®è§£æ±º
                selected_features = resolve_keys(req_body.get('features', []), FEATURE_LABEL_MAP, FEATURE_MAN_DAYS)
                selected_phase2 = resolve_keys(req_body.get('phase2_items', []), PHASE2_LABEL_MAP, PHASE2_ITEMS)
                selected_phase3 = resolve_keys(req_body.get('phase3_items', []), PHASE3_LABEL_MAP, PHASE3_ITEMS)

                # ä¿‚æ•°
                diff_multiplier = config.get('difficulty_multipliers', {}).get(complexity, 1.0)
                dur_multiplier  = config.get('duration_multipliers', {}).get(duration, 1.0)
                dev_type_mults  = config.get('dev_type_multipliers', {}).get(dev_type, {"design":1.0, "dev":1.0})
                dev_type_design_mult = dev_type_mults.get("design", 1.0)
                dev_type_dev_mult    = dev_type_mults.get("dev", 1.0)
                platform_multiplier  = config.get('platform_multipliers', {}).get(target_platform, 1.0)
                buffer_multiplier    = config.get('buffer_multiplier', 1.1)

                # ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
                profiles = config.get('estimation_profiles', {})
                selected_profile = profiles.get(profile_key, profiles['poc'])
                prod_factor = selected_profile.get('productivity_factor', 0.075)

                # ===== å·¥æ•° =====
                dev_feature_days = sum(FEATURE_MAN_DAYS.get(f, 0) for f in selected_features)
                fp_conf = config.get('fp_simplified', {})
                screen_weight = fp_conf.get('screen_weight', 20)
                table_weight  = fp_conf.get('table_weight', 15)
                screen_fp = screen_count * screen_weight
                table_fp  = table_count  * table_weight
                total_ufp = screen_fp + table_fp
                dev_fp_based_days = total_ufp * prod_factor
                dev_base_days = dev_feature_days + dev_fp_based_days
                dev_total_days = dev_base_days * diff_multiplier * dev_type_dev_mult

                # ===== è²»ç”¨ =====
                # ç›´æ¥åŠ´å‹™è²»ï¼šãƒ©ãƒ³ã‚¯äººæœˆÃ—äººæœˆ
                pf = config.get("profit_config", {})
                rank_costs = pf.get("rank_costs", {})
                team_ratio_dict = team_ratio if isinstance(team_ratio, dict) else CONFIG["profit_config"].get("standard_team_ratio", {"Rank3":0.8, "Rank2":0.2})
                direct_labor_cost = compute_direct_labor_cost(dev_total_days, team_ratio_dict, rank_costs)

                # é–“æ¥è²»ï¼šéƒ¨é–€é–“æ¥è²»å˜é‡‘Ã—æ™‚é–“ã€å¿œæ´PJåŠ é‡
                resolved_alloc = dept_allocation if isinstance(dept_allocation, list) else None
                indirect_per_hour, hq_rate, corp_rate = resolve_bs_org_rates(primary_dept, resolved_alloc)
                indirect_cost = compute_indirect_cost(dev_total_days, indirect_per_hour)

                # Phase2ï¼šå›ºå®šè²»ï¼ˆç›´æ¥è²»ã«å«ã‚ã‚‹ï¼‰
                p2_base_cost = sum(PHASE2_ITEMS.get(p, 0) for p in selected_phase2)
                p2_total_cost = int(p2_base_cost * diff_multiplier * dev_type_design_mult)

                # Phase3ï¼šå¤–æ³¨è²»ï¼ˆç¢ºåº¦ä¿‚æ•°ï¼‰
                confidence = req_body.get('confidence')
                p3_total_fixed = 0
                for p in selected_phase3:
                    item = PHASE3_ITEMS.get(p, {})
                    p3_total_fixed += item.get('fixed', 0)
                conf_multiplier = 1.0
                if confidence == 'low':
                    conf_multiplier = 1.3
                elif confidence == 'high':
                    conf_multiplier = 1.0
                p3_final_cost = int(p3_total_fixed * conf_multiplier)

                # COGSï¼šç›´æ¥åŠ´å‹™è²» + é–“æ¥è²» + å¤–æ³¨è²» + Phase2
                cogs = direct_labor_cost + indirect_cost + p3_final_cost + p2_total_cost

                # ===== å£²ä¾¡ï¼ˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ /ç´æœŸ/ãƒãƒƒãƒ•ã‚¡ã¯å£²ä¾¡å´ã«å¯„ä¸ï¼‰ =====
                base_estimated_amount = cogs
                final_amount = int(base_estimated_amount * platform_multiplier * dur_multiplier * buffer_multiplier)

                # ===== æç›Šï¼ˆç²—åˆ©ãƒ™ãƒ¼ã‚¹SG&Aï¼‰ =====
                profit_data = calculate_profitability_bs(final_amount, cogs, hq_rate, corp_rate, target_margin)

                return {
                    "status": "success",
                    "estimated_amount": f"Â¥{final_amount:,}",
                    "estimated_range": f"Â¥{int(final_amount*0.9):,} - Â¥{int(final_amount*1.2):,}",
                    "man_days": {
                        "development_total": round(dev_total_days, 1),
                        "fp_based": round(dev_fp_based_days, 1),
                        "feature_based": round(dev_feature_days, 1),
                    },
                    "bs_input": {
                        "department": primary_dept or DEFAULT_BS_DEPT,
                        "dept_allocation": resolved_alloc,
                        "hq_sga_rate_applied": f"{hq_rate:.1%}",
                        "corp_sga_rate_applied": f"{corp_rate:.1%}",
                        "indirect_yen_per_hour": indirect_per_hour,
                        "team_ratio": team_ratio_dict,
                    },
                    "input_echo": {
                        "profile": selected_profile.get('label'),
                        "profile_description": selected_profile.get('description'),
                        "screen_count": screen_count,
                        "table_count": table_count,
                        "tables": tables,
                        "complexity": complexity,
                        "duration": duration,
                        "dev_type": dev_type,
                        "target_platform": target_platform,
                        "confidence": confidence,
                        "target_margin": target_margin,
                        "features": selected_features,
                        "phase2_items": selected_phase2,
                        "phase3_items": selected_phase3,
                    },
                    "profit_analysis": profit_data,
                    "productivity": f"{prod_factor} MD/FP",
                }

            def main(**kwargs) -> dict:
                # Dify Code Node entrypoint
                args = dict(kwargs)

                # listé …ç›®ã®å‰å‡¦ç†
                for key in ['features', 'phase2_items', 'phase3_items', 'tables']:
                    val = args.get(key)
                    args[key] = parse_list_from_text(val)

                # æ•°å€¤é …ç›®
                for key in ['screen_count', 'table_count']:
                    args[key] = parse_int(args.get(key))

                # tablesãŒã‚ã‚Œã°table_countã‚’è‡ªå‹•è£œå®Œ
                if args.get('tables') and (args.get('table_count') is None or args.get('table_count') == 0):
                    args['table_count'] = len(args['tables'])

                # ç›®æ¨™å–¶æ¥­åˆ©ç›Šç‡
                args['target_margin'] = parse_target_margin(args.get('target_margin'))

                # éƒ¨é–€
                dept = args.get('department')
                if not dept or dept not in BS_ORG_CONFIG:
                    args['department'] = DEFAULT_BS_DEPT

                # å¿œæ´é…åˆ†ï¼ˆæ–‡å­—åˆ—â†’é…åˆ—ã«æ­£è¦åŒ–ï¼‰
                if isinstance(args.get('dept_allocation'), str):
                    args['dept_allocation'] = parse_dept_allocation(args['dept_allocation'])

                # ãƒ©ãƒ³ã‚¯ãƒŸãƒƒã‚¯ã‚¹
                if isinstance(args.get('team_ratio'), str):
                    args['team_ratio'] = parse_team_ratio(args['team_ratio'])

                data = main_logic(args, args.get('tables', []))
                return {"result": json.dumps(data, ensure_ascii=False, indent=2)}
          outputs:
            result:
              type: string
              title: çµæœJSON
          variables:
            - { value_selector: [start, department],         value_type: string, variable: department }
            - { value_selector: [start, dept_allocation],    value_type: string, variable: dept_allocation }
            - { value_selector: [start, team_ratio],         value_type: string, variable: team_ratio }
            - { value_selector: [start, estimation_profile], value_type: string, variable: estimation_profile }
            - { value_selector: [start, target_margin],      value_type: string, variable: target_margin }
            - { value_selector: [start, target_platform],    value_type: string, variable: target_platform }
            - { value_selector: [start, dev_type],           value_type: string, variable: dev_type }
            - { value_selector: [start, screen_count],       value_type: number, variable: screen_count }
            - { value_selector: [start, tables],             value_type: string, variable: tables }
            - { value_selector: [start, table_count],        value_type: number, variable: table_count }
            - { value_selector: [start, features],           value_type: string, variable: features }
            - { value_selector: [start, complexity],         value_type: string, variable: complexity }
            - { value_selector: [start, duration],           value_type: string, variable: duration }
            - { value_selector: [start, confidence],         value_type: string, variable: confidence }
            - { value_selector: [start, phase2_items],       value_type: string, variable: phase2_items }
            - { value_selector: [start, phase3_items],       value_type: string, variable: phase3_items }

      # ---- LLM: ææ¡ˆæ–‡ç”Ÿæˆ ----
      - id: llm
        type: llm
        position: { x: 980, y: 280 }
        data:
          title: LLM
          model:
            provider: langgenius/gemini/google
            name: gemini-2.0-flash
            mode: chat
            completion_params:
              temperature: 0.7
          prompt_config:
            prompt_template:
              - id: sys-1
                role: system
                edition_type: basic
                text: |
                  ã‚ãªãŸã¯ã€æ ªå¼ä¼šç¤¾NTTãƒ‡ãƒ¼ã‚¿CCSã®BSäº‹æ¥­éƒ¨ã®è¦‹ç©ãƒ»æç›Šã«ç²¾é€šã—ãŸææ¡ˆã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã§ã™ã€‚
                  å…¥åŠ›ï¼ˆJSONï¼‰ã«åŸºã¥ãã€å‰æã®ã‚¨ã‚³ãƒ¼ãƒãƒƒã‚¯ â†’ æ¦‚ç®—ç·é¡ â†’ å·¥æ•°å†…è¨³ã¨æ ¹æ‹  â†’ åç›Šæ€§ï¼ˆç²—åˆ©ãƒ»å–¶æ¥­åˆ©ç›Šï¼‰ â†’
                  ç›®æ¨™å–¶æ¥­åˆ©ç›Šç‡ã«å¯¾ã™ã‚‹é€†ç®—ä¾¡æ ¼ã®æ¯”è¼ƒ â†’ ãƒªã‚¹ã‚¯/ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ã®é †ã§ã€ç°¡æ½”ã‹ã¤èª¬å¾—åŠ›ã®ã‚ã‚‹æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
                  é‡‘é¡ã¯JPYã§3æ¡åŒºåˆ‡ã‚Šã€‚æ•°å€¤ã¯JSONã®å€¤ã‚’æ­£ã¨ã—ã¦ã€å‹æ‰‹ã«æ”¹å¤‰ã—ãªã„ã“ã¨ã€‚
                  ãªãŠã€BSäº‹æ¥­éƒ¨ã¯ FY2026åˆ©ç›Šç®¡ç†è¡¨ã®ä¿‚æ•°ï¼ˆ1äººæœˆ=160hã€éƒ¨é–€åˆ¥é–“æ¥è²»å˜é‡‘ã€è²©ç®¡è²»ã¯ç²—åˆ©ãƒ™ãƒ¼ã‚¹ã€æœ¬éƒ¨+å…¨ç¤¾=47.8%ï¼‰ã«æº–æ‹ ã€‚  # æ ¹æ‹ : PDF  [1](blob:https://outlook.office.com/d41819a6-5b12-4021-a406-776e8d2dd80e)
              - id: usr-1
                role: user
                edition_type: basic
                text: |
                  ### è¨ˆç®—çµæœãƒ‡ãƒ¼ã‚¿(JSON)
                  {{#code.result#}}

      # ---- Answer: å‡ºåŠ› ----
      - id: answer
        type: answer
        position: { x: 1280, y: 280 }
        data:
          title: å›ç­”
          answer: "{{#llm.text#}}"

    edges:
      - { id: e-start-code, source: start, sourceHandle: source, target: code, targetHandle: target, type: custom }
      - { id: e-code-llm,   source: code,  sourceHandle: source, target: llm,  targetHandle: target, type: custom }
      - { id: e-llm-answer, source: llm,   sourceHandle: source, target: answer, targetHandle: target, type: custom }